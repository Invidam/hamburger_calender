{"ast":null,"code":"const debug = require('debug');\n\nconst {\n  RateLimiter\n} = require('limiter');\n\nconst JwksRateLimitError = require('../errors/JwksRateLimitError');\n\nfunction rateLimtWrapper(client, {\n  jwksRequestsPerMinute = 10\n}) {\n  const logger = debug('jwks');\n  const getSigningKey = client.getSigningKey.bind(client);\n  const limiter = new RateLimiter(jwksRequestsPerMinute, 'minute', true);\n  logger(`Configured rate limiting to JWKS endpoint at ${jwksRequestsPerMinute}/minute`);\n  return async kid => await new Promise((resolve, reject) => {\n    limiter.removeTokens(1, async (err, remaining) => {\n      if (err) {\n        reject(err);\n      }\n\n      logger('Requests to the JWKS endpoint available for the next minute:', remaining);\n\n      if (remaining < 0) {\n        logger('Too many requests to the JWKS endpoint');\n        reject(new JwksRateLimitError('Too many requests to the JWKS endpoint'));\n      } else {\n        try {\n          const key = await getSigningKey(kid);\n          resolve(key);\n        } catch (error) {\n          reject(error);\n        }\n      }\n    });\n  });\n}\n\nmodule.exports.default = rateLimtWrapper;","map":{"version":3,"sources":["/home/invidam/hamburger_calender/client/node_modules/jwks-rsa/src/wrappers/rateLimit.js"],"names":["debug","require","RateLimiter","JwksRateLimitError","rateLimtWrapper","client","jwksRequestsPerMinute","logger","getSigningKey","bind","limiter","kid","Promise","resolve","reject","removeTokens","err","remaining","key","error","module","exports","default"],"mappings":"AAAA,MAAMA,KAAK,GAAGC,OAAO,CAAC,OAAD,CAArB;;AACA,MAAM;AAAEC,EAAAA;AAAF,IAAkBD,OAAO,CAAC,SAAD,CAA/B;;AAEA,MAAME,kBAAkB,GAAGF,OAAO,CAAC,8BAAD,CAAlC;;AAEA,SAASG,eAAT,CAAyBC,MAAzB,EAAiC;AAAEC,EAAAA,qBAAqB,GAAG;AAA1B,CAAjC,EAAiE;AAC/D,QAAMC,MAAM,GAAGP,KAAK,CAAC,MAAD,CAApB;AACA,QAAMQ,aAAa,GAAGH,MAAM,CAACG,aAAP,CAAqBC,IAArB,CAA0BJ,MAA1B,CAAtB;AAEA,QAAMK,OAAO,GAAG,IAAIR,WAAJ,CAAgBI,qBAAhB,EAAuC,QAAvC,EAAiD,IAAjD,CAAhB;AACAC,EAAAA,MAAM,CAAE,gDAA+CD,qBAAsB,SAAvE,CAAN;AAEA,SAAO,MAAOK,GAAP,IAAe,MAAM,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AAC3DJ,IAAAA,OAAO,CAACK,YAAR,CAAqB,CAArB,EAAwB,OAAOC,GAAP,EAAYC,SAAZ,KAA0B;AAChD,UAAID,GAAJ,EAAS;AACPF,QAAAA,MAAM,CAACE,GAAD,CAAN;AACD;;AAEDT,MAAAA,MAAM,CAAC,8DAAD,EAAiEU,SAAjE,CAAN;;AACA,UAAIA,SAAS,GAAG,CAAhB,EAAmB;AACjBV,QAAAA,MAAM,CAAC,wCAAD,CAAN;AACAO,QAAAA,MAAM,CAAC,IAAIX,kBAAJ,CAAuB,wCAAvB,CAAD,CAAN;AACD,OAHD,MAGO;AACL,YAAI;AACF,gBAAMe,GAAG,GAAG,MAAMV,aAAa,CAACG,GAAD,CAA/B;AACAE,UAAAA,OAAO,CAACK,GAAD,CAAP;AACD,SAHD,CAGE,OAAOC,KAAP,EAAc;AACdL,UAAAA,MAAM,CAACK,KAAD,CAAN;AACD;AACF;AACF,KAjBD;AAkBD,GAnB2B,CAA5B;AAoBD;;AAEDC,MAAM,CAACC,OAAP,CAAeC,OAAf,GAAyBlB,eAAzB","sourcesContent":["const debug = require('debug');\nconst { RateLimiter } = require('limiter');\n\nconst JwksRateLimitError = require('../errors/JwksRateLimitError');\n\nfunction rateLimtWrapper(client, { jwksRequestsPerMinute = 10 }) {\n  const logger = debug('jwks');\n  const getSigningKey = client.getSigningKey.bind(client);\n\n  const limiter = new RateLimiter(jwksRequestsPerMinute, 'minute', true);\n  logger(`Configured rate limiting to JWKS endpoint at ${jwksRequestsPerMinute}/minute`);\n\n  return async (kid) => await new Promise((resolve, reject) => {\n    limiter.removeTokens(1, async (err, remaining) => {\n      if (err) {\n        reject(err);\n      }\n\n      logger('Requests to the JWKS endpoint available for the next minute:', remaining);\n      if (remaining < 0) {\n        logger('Too many requests to the JWKS endpoint');\n        reject(new JwksRateLimitError('Too many requests to the JWKS endpoint'));\n      } else {\n        try {\n          const key = await getSigningKey(kid);\n          resolve(key);\n        } catch (error) {\n          reject(error);\n        }\n      }\n    });\n  });\n}\n\nmodule.exports.default = rateLimtWrapper;\n"]},"metadata":{},"sourceType":"script"}